<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ledger - journal</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../book.html"><strong aria-hidden="true">1.</strong> book</a></li><li class="chapter-item expanded "><a href="../../usage.html"><strong aria-hidden="true">2.</strong> Usage</a></li><li class="chapter-item expanded "><a href="../../trading_functions/index.html"><strong aria-hidden="true">3.</strong> Trading Functions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../trading_functions/dynamic_function_market_makers.html"><strong aria-hidden="true">3.1.</strong> Dynamic Function Market Makers</a></li><li class="chapter-item expanded "><a href="../../trading_functions/geometric_mean.html"><strong aria-hidden="true">3.2.</strong> Geometric Mean</a></li><li class="chapter-item expanded "><a href="../../trading_functions/log_normal.html"><strong aria-hidden="true">3.3.</strong> Log Normal</a></li><li class="chapter-item expanded "><a href="../../trading_functions/linear.html"><strong aria-hidden="true">3.4.</strong> Linear</a></li></ol></li><li class="chapter-item expanded "><a href="../../strategies/index.html"><strong aria-hidden="true">4.</strong> Strategies</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../strategies/dollar_cost_averaging.html"><strong aria-hidden="true">4.1.</strong> Dollar Cost Averaging</a></li><li class="chapter-item expanded "><a href="../../strategies/volatility_targeting.html"><strong aria-hidden="true">4.2.</strong> Volatility Targeting</a></li><li class="chapter-item expanded "><a href="../../strategies/momentum.html"><strong aria-hidden="true">4.3.</strong> Momentum</a></li></ol></li><li class="chapter-item expanded "><a href="../../analysis/index.html"><strong aria-hidden="true">5.</strong> Analysis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../analysis/dollar_cost_averaging.html"><strong aria-hidden="true">5.1.</strong> Dollar Cost Averaging</a></li><li class="chapter-item expanded "><a href="../../analysis/volatility_targeting.html"><strong aria-hidden="true">5.2.</strong> Volatility Targeting</a></li></ol></li><li class="chapter-item expanded "><a href="../../agents/index.html"><strong aria-hidden="true">6.</strong> Agents</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../agents/arbitrageur.html"><strong aria-hidden="true">6.1.</strong> Arbitrageur</a></li><li class="chapter-item expanded "><a href="../../agents/price_changer.html"><strong aria-hidden="true">6.2.</strong> Price Changer</a></li><li class="chapter-item expanded "><a href="../../agents/weight_changer.html"><strong aria-hidden="true">6.3.</strong> Weight Changer</a></li></ol></li><li class="chapter-item expanded "><a href="../../dev_notes/index.html"><strong aria-hidden="true">7.</strong> Dev Notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../dev_notes/ledger/index.html" class="active"><strong aria-hidden="true">7.1.</strong> ledger</a></li><li class="chapter-item expanded "><a href="../../dev_notes/CI/index.html"><strong aria-hidden="true">7.2.</strong> CI Testing</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/ui.html"><strong aria-hidden="true">7.3.</strong> User Interface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-1.html"><strong aria-hidden="true">7.3.1.</strong> dec-1</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-5.html"><strong aria-hidden="true">7.3.2.</strong> dec-5</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-11.html"><strong aria-hidden="true">7.3.3.</strong> dec-11</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-12.html"><strong aria-hidden="true">7.3.4.</strong> dec-12</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-13.html"><strong aria-hidden="true">7.3.5.</strong> dec-13</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-14.html"><strong aria-hidden="true">7.3.6.</strong> dec-14</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-16.html"><strong aria-hidden="true">7.3.7.</strong> dec-16</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/dec-17.html"><strong aria-hidden="true">7.3.8.</strong> dec-17</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/executing_tx.html"><strong aria-hidden="true">7.3.9.</strong> executing_tx</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/firehose.html"><strong aria-hidden="true">7.3.10.</strong> firehose</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-13.html"><strong aria-hidden="true">7.3.11.</strong> nov-13</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-16.html"><strong aria-hidden="true">7.3.12.</strong> nov-16</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-17.html"><strong aria-hidden="true">7.3.13.</strong> nov-17</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-21.html"><strong aria-hidden="true">7.3.14.</strong> nov-21</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-22.html"><strong aria-hidden="true">7.3.15.</strong> nov-22</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-24.html"><strong aria-hidden="true">7.3.16.</strong> nov-24</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-25.html"><strong aria-hidden="true">7.3.17.</strong> nov-25</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-26.html"><strong aria-hidden="true">7.3.18.</strong> nov-26</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-27.html"><strong aria-hidden="true">7.3.19.</strong> nov-27</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-29.html"><strong aria-hidden="true">7.3.20.</strong> nov-29</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/nov-30.html"><strong aria-hidden="true">7.3.21.</strong> nov-30</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/tracer.html"><strong aria-hidden="true">7.3.22.</strong> tracer</a></li><li class="chapter-item expanded "><a href="../../dev_notes/ui/ui-refactor-nov-8.html"><strong aria-hidden="true">7.3.23.</strong> ui-refactor-nov-8</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">journal</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="ledger"><a class="header" href="#ledger">Ledger</a></h1>
<p>The ledger hardware communicates via the application protocol data unit <a href="https://en.wikipedia.org/wiki/Smart_card_application_protocol_data_unit">(APDU)</a>. This unit is responsible for the communication between the ledger hardware and the host computer. The APDU is a binary format and is used to send commands to the ledger hardware and to receive responses from the ledger hardware. The protocol consists of a command response. </p>
<h2 id="command"><a class="header" href="#command">Command</a></h2>
<p>An APDU command consists of the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>CLA</td><td>Class of the instruction, indicates the type of the command interindustry or proprietary</td></tr>
<tr><td>INS</td><td>Instruction code, this is defined by each ledger application, think of it as the application instruction set</td></tr>
<tr><td>P1 &amp; P2</td><td>Instruction parameters if the instruction has arguments</td></tr>
<tr><td>Lc</td><td>Number of bytes present in the data field of the command.</td></tr>
<tr><td>Data</td><td>Data field of the command.</td></tr>
<tr><td>Le</td><td>Maximum number of bytes expected in the data field of the response to the command.</td></tr>
</tbody></table>
</div>
<h2 id="response"><a class="header" href="#response">Response</a></h2>
<p>The response to an APDU command consists of the following fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>Data</td><td>Data field of the response.</td></tr>
<tr><td>SW1 &amp; SW2</td><td>Status word of the response.</td></tr>
</tbody></table>
</div>
<p>A complete list of the status words can be found <a href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses">here</a>.</p>
<h2 id="ledger-ethereum"><a class="header" href="#ledger-ethereum">Ledger Ethereum</a></h2>
<p>The embedded Ethereum app on the ledger hardware is responsible for signing Ethereum transactions. This is the application we want to communicate with. The application has a set of instructions that it understands. The source code for the application is <a href="https://github.com/LedgerHQ/app-ethereum">here</a>. When a user updates their ethereum application they do it with the next version release of this repository. </p>
<h2 id="ledger-rust-sdk-ecosystem"><a class="header" href="#ledger-rust-sdk-ecosystem">Ledger Rust SDK Ecosystem</a></h2>
<p>There are a few abstractions around this protocol different people have worked on. The most notable ones are:</p>
<ul>
<li><a href="https://github.com/LedgerHQ/ledger-device-rust-sdk">Official Ledger SDK</a>: I tried working with this one first. It was not bad and I still look at it for reference. There is also this other library <a href="https://github.com/LYC386/ledger-tauri">Ledger Tauri</a>. That is a good reference I still look at.</li>
<li><a href="https://github.com/gakonst/ethers-rs/tree/master/ethers-signers">ether-rs ledger signer</a>: I tried working with this one second because I was excited about having some generic abstraction over signers. Turns out this one is kind of broken. However, I did learn that it was built by James on top of this well-maintained library summa coins</li>
<li><a href="https://github.com/summa-tx/coins">summa-coins</a>: This is the library I ended up building my solution on top of. It is also what will be used when rewriting the ledger-signer in alloy (or at least that's what James told me) so it felt like the best option. I was impressed with this library and how well it was built. It also has support for both bip32 and bip39.</li>
</ul>
<h2 id="ledger-client"><a class="header" href="#ledger-client">Ledger Client</a></h2>
<p>LedgerClient is the SDK in our repository built on top of the summa-coins library. It provides a minimal SDK around the Ledger Ethereum application. It currently supports a subset of all the ethereum ledger instructions but we can add more support later.</p>
<h3 id="utilization"><a class="header" href="#utilization">Utilization</a></h3>
<p>When communicating with the ledger device we need to acquire a lock on the <code>HIDTransport</code>. This means that if there is another application talking to the ledger, this will not work. After obtaining the lock on the ledger we can interact with the ethereum application if it is open. If it is not open we will only be able to send instructions that return meta-data about the application. For example, we can check the version of the application. </p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use clients::ledger::LedgerClient;

let ledger = LedgerClient::new_connection(clients::ledger::types::DerivationType::LedgerLive(0)).await;
<span class="boring">}</span></code></pre></pre>
<p>When creating a new ledger connection you must specify the account derivation path indicated by bitcoin improvement proposal 32 <a href="https://www.youtube.com/watch?v=2HrMlVr1QX8">bip32</a>. This allows for a hierarchical deterministic wallet. The derivation path is a string that looks like this <code>m/44'/60'/0'/0/0</code>. The first part of the path is the purpose. The second part is the coin type. The third part is the account. The fourth part is the change. The fifth part is the address index. The <code>LedgerClient</code> will use this path to derive the public key for the address index. </p>
<p>In most cases we will want to use the <code>LedgerLive</code> derivation type. This is the derivation path used by the ledger live application. The <code>LedgerLive</code> derivation type takes an index as an argument. This is the index of the account in the ledger live application. The <code>LedgerLive</code> derivation type will derive the derivation path for the account at the index. </p>
<p>When we have a ledger connection we can use it to sign transactions by giving it an ethers transaction request </p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let tx = TransactionRequest::default();

// This currently correctly prompts the user to review this transaction
let sig = ledger.sign_tx(&amp;tx).await.unwrap();
// once a user approves the transaction this will resolve and return the ethers signature type
<span class="boring">}</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../dev_notes/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../dev_notes/CI/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../dev_notes/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../dev_notes/CI/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
